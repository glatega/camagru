<html>
	<body>
		<style>
		#camera_buttons, #effects, video, canvas {
			max-width: 640px;
			height: auto;
			border: 3px solid;
		}
		.buttpic {
			width: 50px;
			height: 50px;
			margin: 10px 10%;
			border: none;
		}
		#camera_buttons {
			text-align: center;
			border: 3px solid;
			border-top: none;
			background-color: #cccccc;
		}
		#cambox {
			width: 646px;
			margin: 0 auto;
		}
		#effects {
			border-radius: 10px;
			margin-top: 10px;
			background-color: #cccccc;
			overflow: hidden;
		}
		#effect_btns {
			text-align: center;
			cursor: pointer;
		}
		.effect_btn {
			padding: 10px 0px;
			width: calc(calc(100% - 2px)/3);
			display: inline-block;
			border-left: 1px solid;
			border-bottom: 1px solid;
			background-color: #7b7b7b;
		}
		.td_filter {
			display: flex;
		}
		.filters {
			flex-grow: 1;
		}
		#filter_btn {
			border-left: none;
		}
		#filter_box {
			width: 100%;
		}
		#mask_box {
			width: 100%;
			height: 100px;
			background-color: aquamarine;
		}
		#frame_box {
			width: 100%;
			height: 100px;
			background-color: palevioletred;
		}
		</style>
		<div>
			<div id="cambox">
				<div>
					<canvas id="canvas"></canvas>
					<div id="camera_buttons">
						<button class="buttpic" id="rainbow" style="background: url(./imgs/rainbow.svg)"></button>
						<button class="buttpic" id="snap" style="background: url(./imgs/camera.svg)"></button>
						<button class="buttpic" id="cancel" style="background: url(./imgs/trash.png); background-size: cover"></button>
					</div>
				</div>
				<div id="effects">
					<div id="effect_btns">
						<div id="filter_btn" onclick="clickEffect('filter_btn')" class="effect_btn">
							<img width="auto" height="35px" class="cute_ghost" src="./imgs/filter.svg">
						</div><!-- 
						--><div id="mask_btn" onclick="clickEffect('mask_btn')" class="effect_btn">
							<img width="auto" height="35px" class="cute_ghost" src="./imgs/mask.svg">
						</div><!-- 
						--><div id="frame_btn" onclick="clickEffect('frame_btn')" class="effect_btn">
							<img width="auto" height="35px" class="cute_ghost" src="./imgs/frame.svg">
						</div>
					</div>
					<table id="filter_box" style="width: 100%">
						<!-- <tr>
							<th>
								<img width="auto" height="35px" class="cute_ghost" src="./imgs/filter.svg">
							</th>
							<th>
								Filters
							</th>
						</tr> -->
						<tr>
							<td>Blur</td>
							<td class="td_filter"><input class="filters" min="0" max="20" value="0" step="1" oninput="applyFilter()" data-filter="blur" data-scale="px" type="range"></td>
						</tr>
						<tr>
							<td>Brightness</td>
							<td class="td_filter"><input class="filters" min="0" max="200" value="100" step="1" oninput="applyFilter()" data-filter="brightness" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Contrast</td>
							<td class="td_filter"><input class="filters" min="0" max="200" value="100" step="1" oninput="applyFilter()" data-filter="contrast" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Grayscale?</td>
							<td class="td_filter"><input class="filters" min="0" max="100" value="0" step="1" oninput="applyFilter()" data-filter="grayscale" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Hue Rotate</td>
							<td class="td_filter"><input id="hue" class="filters" min="0" max="360" value="0" step="1" oninput="applyFilter()" data-filter="hue-rotate" data-scale="deg" type="range"></td>
						</tr>
						<tr>
							<td>Invert</td>
							<td class="td_filter"><input class="filters" min="0" max="100" value="0" step="1" oninput="applyFilter()" data-filter="invert" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Opacity</td>
							<td class="td_filter"><input class="filters" min="0" max="100" value="100" step="1" oninput="applyFilter()" data-filter="opacity" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Saturate</td>
							<td class="td_filter"><input class="filters" min="1" max="100" value="100" step="1" oninput="applyFilter()" data-filter="saturate" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Sepia</td>
							<td class="td_filter"><input class="filters" min="0" max="100" value="0" step="1" oninput="applyFilter()" data-filter="sepia" data-scale="%" type="range"></td>
						</tr>
						<tr>
							<td>Fade delay</td>
							<td class="td_filter"><input style="flex-grow: 1" id="fadeDelay" min="0" max="0.99" value="0" step="0.01" data-scale="%" type="range"></td>
						</tr>
					</table>
					<div id="mask_box">

					</div>
					<div id="frame_box">
						
					</div>
				</div>
			</div>
		</div>

		
		<script>
		
		function clickEffect($button) {
			btns = document.querySelectorAll('.effect_btn');
			for (i = 0; i < btns.length; i++) {
				btns[i].setAttribute("style", "border-bottom:1px solid; background-color: #7b7b7b;");
			}
			document.getElementById($button).setAttribute("style", "border-bottom:none; background-color: #cccccc;");
			switch ($button) {
				case "filter_btn":
					document.getElementById("mask_box").setAttribute("style", "display:none;");
					document.getElementById("frame_box").setAttribute("style", "display:none;");
					document.getElementById("filter_box").setAttribute("style", "display:table;");
					break;
				case "mask_btn":
					document.getElementById("frame_box").setAttribute("style", "display:none;");
					document.getElementById("filter_box").setAttribute("style", "display:none;");
					document.getElementById("mask_box").setAttribute("style", "display:block;");
					break;
				case "frame_btn":
					document.getElementById("mask_box").setAttribute("style", "display:none;");
					document.getElementById("filter_box").setAttribute("style", "display:none;");
					document.getElementById("frame_box").setAttribute("style", "display:block;");
					break;
			}
		}

		activePic = 0;

		activeRainbow = 0;
		refreshIntervalId = 0;
		document.querySelector('#rainbow').onclick = function() {
			if (activeRainbow == 0) {
				activeRainbow = 1;
				refreshIntervalId = setInterval(
					function() {
						if (document.querySelector('#hue').value == 360) {
							document.querySelector('#hue').value = 0;
						}
						val = parseInt(document.querySelector('#hue').value) + 1;
						document.querySelector('#hue').value = val;
						applyFilter();
					},
					1
				);
			} else {
				clearInterval(refreshIntervalId);
				activeRainbow = 0;
			}
		}

		canvas = document.getElementById('canvas');

		var filterControls = document.querySelectorAll('.filters');
		function applyFilter() {
			var computedFilters = '';
			filterControls.forEach(function(item, index) {
				computedFilters += item.getAttribute('data-filter') + '(' + item.value + item.getAttribute('data-scale') + ') ';
			});
			canvas.style.filter = computedFilters;
		};

		window.onload = function() {

			navigator.getUserMedia  = navigator.getUserMedia ||
									navigator.webkitGetUserMedia ||
									navigator.mozGetUserMedia ||
									navigator.msGetUserMedia;

			
			video = document.createElement('video');
			video.setAttribute('autoplay',true);
			
			ctx = canvas.getContext('2d');
			fadeDelay = document.getElementById('fadeDelay');

			window.vid = video;
			
			function getWebcam() {
				navigator.getUserMedia({ video: true, audio: false }, function(stream) {
					video.srcObject = stream;
					track = stream.getTracks()[0];
				}, function(e) {
					console.error('Rejected!', e);
				});
			}
			
			getWebcam();
			
			var loopFrame;
			
			function loop() {
				// ctx.save();
				// ctx.restore();
				
				ctx.globalAlpha = 1 - Math.pow(fadeDelay.value, 1/3);
				ctx.drawImage(video, 0, 0, width, height);
				
				loopFrame = requestAnimationFrame(loop);
			}
			
			function startLoop() {
				ctx.translate(width, 0);
				ctx.scale(-1, 1);
				loopFrame = loopFrame || requestAnimationFrame(loop);
			}
			
			video.addEventListener('loadedmetadata',function(){
				width = canvas.width = video.videoWidth;
				height = canvas.height = video.videoHeight;
				startLoop();
			});
			
			document.querySelector('#snap').onclick = function() {
				activePic = 1;
				cancelAnimationFrame(loopFrame);
				if (refreshIntervalId != 0) {
					clearInterval(refreshIntervalId);
					active = 0;
				}
			}

			document.querySelector('#cancel').onclick = function() {
				if (activePic == 1) {
					activePic = 0;
					loopFrame = requestAnimationFrame(loop);
				}
			}

		}

		window.onunload = function() {}
		</script>
	</body>
</html>
