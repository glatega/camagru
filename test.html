<html>
	<body>
		<style>
		video, canvas { max-width: 100%; height: auto; }
		.buttpic {
			width: 50px;
			height: 50px;
		}
		</style>
		<canvas id="canvas"></canvas><br>
		<button class="buttpic" id="snap" style="background: url(./imgs/camera.svg)"></button><br>
		<button class="buttpic" id="cancel" style="background: url(./imgs/trash.png); background-size: cover"></button><br>
		<button class="buttpic" id="rainbow" style="background: url(./imgs/rainbow.svg)"></button><br>
		<table>
			<tr>
				<td>Blur</td>
				<td><input class="filters" min="0" max="20" value="0" step="1" oninput="applyFilter()" data-filter="blur" data-scale="px" type="range"></td>
			</tr>
			<tr>
				<td>Brightness</td>
				<td><input class="filters" min="0" max="200" value="100" step="1" oninput="applyFilter()" data-filter="brightness" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Contrast</td>
				<td><input class="filters" min="0" max="200" value="100" step="1" oninput="applyFilter()" data-filter="contrast" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Grayscale?</td>
				<td><input class="filters" min="0" max="100" value="0" step="1" oninput="applyFilter()" data-filter="grayscale" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Hue Rotate</td>
				<td><input id="hue" class="filters" min="0" max="360" value="0" step="1" oninput="applyFilter()" data-filter="hue-rotate" data-scale="deg" type="range"></td>
			</tr>
			<tr>
				<td>Invert</td>
				<td><input class="filters" min="0" max="100" value="0" step="1" oninput="applyFilter()" data-filter="invert" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Opacity</td>
				<td><input class="filters" min="0" max="100" value="100" step="1" oninput="applyFilter()" data-filter="opacity" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Saturate</td>
				<td><input class="filters" min="1" max="100" value="100" step="1" oninput="applyFilter()" data-filter="saturate" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Sepia</td>
				<td><input class="filters" min="0" max="100" value="0" step="1" oninput="applyFilter()" data-filter="sepia" data-scale="%" type="range"></td>
			</tr>
			<tr>
				<td>Fade delay</td>
				<td><input id="fadeDelay" min="0" max="0.99" value="0" step="0.01" data-scale="%" type="range"></td>
			</tr>
		</table>

		<script>
		
		activePic = 0;

		activeRainbow = 0;
		refreshIntervalId = 0;
		document.querySelector('#rainbow').onclick = function() {
			if (activeRainbow == 0) {
				activeRainbow = 1;
				refreshIntervalId = setInterval(
					function() {
						if (document.querySelector('#hue').value == 360) {
							document.querySelector('#hue').value = 0;
						}
						val = parseInt(document.querySelector('#hue').value) + 1;
						document.querySelector('#hue').value = val;
						applyFilter();
					},
					1
				);
			} else {
				clearInterval(refreshIntervalId);
				activeRainbow = 0;
			}
		}

		canvas = document.getElementById('canvas');

		var filterControls = document.querySelectorAll('.filters');
		function applyFilter() {
			var computedFilters = '';
			filterControls.forEach(function(item, index) {
				computedFilters += item.getAttribute('data-filter') + '(' + item.value + item.getAttribute('data-scale') + ') ';
			});
			canvas.style.filter = computedFilters;
		};

		window.onload = function() {

			navigator.getUserMedia  = navigator.getUserMedia ||
									navigator.webkitGetUserMedia ||
									navigator.mozGetUserMedia ||
									navigator.msGetUserMedia;

			
			video = document.createElement('video');
			video.setAttribute('autoplay',true);
			
			ctx = canvas.getContext('2d');
			fadeDelay = document.getElementById('fadeDelay');

			window.vid = video;
			
			function getWebcam() {
				navigator.getUserMedia({ video: true, audio: false }, function(stream) {
					video.srcObject = stream;
					track = stream.getTracks()[0];
				}, function(e) {
					console.error('Rejected!', e);
				});
			}
			
			getWebcam();
			
			var loopFrame;
			
			function loop() {
				// ctx.save();
				// ctx.restore();
				
				ctx.globalAlpha = 1 - Math.pow(fadeDelay.value, 1/3);
				ctx.drawImage(video, 0, 0, width, height);
				
				loopFrame = requestAnimationFrame(loop);
			}
			
			function startLoop() {
				ctx.translate(width, 0);
				ctx.scale(-1, 1);
				loopFrame = loopFrame || requestAnimationFrame(loop);
			}
			
			video.addEventListener('loadedmetadata',function(){
				width = canvas.width = video.videoWidth;
				height = canvas.height = video.videoHeight;
				startLoop();
			});
			
			document.querySelector('#snap').onclick = function() {
				activePic = 1;
				cancelAnimationFrame(loopFrame);
				if (refreshIntervalId != 0) {
					clearInterval(refreshIntervalId);
					active = 0;
				}
			}

			document.querySelector('#cancel').onclick = function() {
				if (activePic == 1) {
					activePic = 0;
					loopFrame = requestAnimationFrame(loop);
				}
			}

		}

		window.onunload = function() {}
		</script>
	</body>
</html>
